name: CI - Build & Test

on:
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # ===== Lấy mã nguồn =====
      - name: Lấy mã nguồn từ repository
        uses: actions/checkout@v4

      # ===== Thiết lập Docker Buildx =====
      - name: Thiết lập Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ===== Build image Docker với cache =====
      - name: Build image Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          load: true
          tags: milk_app:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== Chạy container kiểm thử =====
      - name: Chạy container kiểm thử
        run: |
          docker run -d -p 8080:80 --name test_app milk_app:test

      # ===== Kiểm tra ứng dụng đã sẵn sàng =====
      - name: Kiểm tra ứng dụng đã sẵn sàng
        run: |
          for i in {1..20}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080 || true)
            if [ "$STATUS" = "200" ]; then
              echo "Ứng dụng đã sẵn sàng"
              exit 0
            fi
            echo "Đang chờ ứng dụng khởi động... lần thử $i"
            sleep 3
          done

          echo "Ứng dụng không khởi động thành công"
          docker logs test_app
          exit 1

      # ===== Hiển thị container đang chạy =====
      - name: Hiển thị danh sách container
        run: docker ps -a

      # ===== Dọn dẹp container =====
      - name: Dọn dẹp container kiểm thử
        if: always()
        run: docker rm -f test_app || true