name: CI - Build & Test

on:
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # ===== Lấy mã nguồn =====
      - name: Lấy mã nguồn
        uses: actions/checkout@v4

      # ===== Cài đặt Docker Buildx =====
      - name: Cài đặt Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ===== Build Docker image =====
      - name: Build image Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.prod
          push: false
          tags: milk_app:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== Chạy container kiểm thử =====
      - name: Chạy container kiểm thử
        run: |
          docker run -d -p 8080:80 --name test_app milk_app:test

      # ===== Chờ ứng dụng khởi động =====
      - name: Kiểm tra ứng dụng đã sẵn sàng
        run: |
          for i in {1..20}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080 || true)
            if [ "$STATUS" = "200" ]; then
              echo "Ứng dụng đã sẵn sàng"
              exit 0
            fi
            echo "Đang chờ ứng dụng... lần $i"
            sleep 3
          done

          echo "Ứng dụng không khởi động được"
          docker logs test_app
          exit 1

      # ===== Hiển thị container (debug) =====
      - name: Hiển thị danh sách container
        run: docker ps -a

      # ===== Dọn dẹp container =====
      - name: Dọn dẹp container kiểm thử
        if: always()
        run: docker rm -f test_app || true